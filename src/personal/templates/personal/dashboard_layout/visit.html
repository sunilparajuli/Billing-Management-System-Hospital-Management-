{% extends 'personal/dashboard_layout/app.html' %}

{% load static %}

{% block content %}
<div class="row" id="add_visit">
    <div class="col-sm-12">
        <div class="card-box">
            <h4 class="header-title">Visit </h4>
            <p class="sub-header">
               Register New Visit 
            </p>

            <div class="row">
                <div class="col-lg-6">
                    <div class="form-horizontal">
                        {% comment %}
                        <div class="form-group row">
                            <label class="col-md-2 control-label">Reg. Charge / Amount</label>
                            <div class="col-md-10">
                                <input type="text" class="form-control" v-model="Visit.amount" value="" placeholder="amount...">
                            </div>
                        </div>
                        
                        <div class="form-group row">
                            <label class="col-md-2 control-label" for="example-email">Type</label>
                            <div class="col-md-10">
                                <!-- <input type="email" id="example-email" name="example-email" class="form-control" placeholder="Email"> -->
                                <select name="" @change="onChangeVisitType($event)" v-model="Visit.fk_type_id" class="select2">
                                    {% for  type in visits_type %}
                                        <option value="{{type.id}}">{{type.title}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group row">
                            <label class="col-md-2 control-label" for="example-email">Service/ Items</label>
                            <div class="col-md-10">
                                <!-- <input type="email" id="example-email" name="example-email" class="form-control" placeholder="Email"> -->
                                <select name="" v-model="Visit.cartitem_id" class="select2" @change="onChangeVariation($event)">
                                    {% for  variation in variations %}
                                        <option value="{{variation.id}}">{{variation.title}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        {% endcomment %}


                        <div class="form-group row">
                            <label class="col-sm-2 control-label"> Customer</label>
                            <div class="col-sm-8">
                                <select class="form-control" v-model="fk_customer_user_id">
                                    <option  v-for="(patient, index) in patients" v-bind:value="patient.id">[[ patient.firstname ]] [[patient.lastname]] [[patient.mobile]]</option>
                                </select>
                            </div>
                            <div class="col-sm-2">
                                <button class="btn btn-primary waves-effect waves-light" data-toggle="modal" data-target="#con-close-modal">Add Customer</button>
                            </div>
                        </div>

                        <div class="form-group row">
                            <label class="col-sm-2 control-label"> Reffer Doctor</label>
                            <div class="col-sm-6">
                                <select class="form-control" v-model="fk_doctor_user_id">
                                    <option  v-for="(doctor, index) in doctors.results" v-bind:value="doctor.id">[[ doctor.firstname ]] [[doctor.lastname]] [[doctor.mobile]]</option>
                                </select>
                            </div>
                            <label class="col-sm-2 control-label"> Visit Type</label>
                            <div class="col-sm-2">
                                <div class="form-group">                                   
                                    <select class="form-control" v-model="visit_type">
                                        {% for visit_type in visits_types %}
                                            <option value="{{visit_type.id}}">{{visit_type.title}}</option>
                                        {% endfor %}
                                        
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-2 control-label">Appointment Date</label>
                            
                                <div class="input-group col-sm-4">
                                    <input type="text"  v-model="appointmentDate" class="form-control datepicker" placeholder="mm/dd/yyyy" id="">
                                    <div class="input-group-append">
                                        <span class="input-group-text bg-primary text-white b-0"><i class="mdi mdi-calendar"></i></span>
                                    </div>

                                </div>
                                <label class="col-md-1 control-label"> Remarks</label>
                            <div class="col-sm-5">
                                <input type="text" v-model="remarks" class="form-control" value="" placeholder="Remarks">
                            </div>
                            
                        </div>

                       
                    </div>
                </div>
         

            </div>
            <button class="btn btn-info" @click="saveVisit">Submit</button>
        
            </div>
            <!-- end row -->

            <!-- end row -->

        </div>
        <div id="con-close-modal" class="modal fade" tabindex="-1" role="dialog" aria-hidden="true"  style="display: none;">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h4 class="modal-title mt-0">Add New Customer</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="field-1" class="control-label">First Name</label>
                                    <input type="text" class="form-control" v-model="customerForm.firstname" id="field-1" placeholder="John">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="field-2" class="control-label">Last Name</label>
                                    <input type="text" class="form-control" v-model="customerForm.lastname" id="field-2" placeholder="Doe">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="field-3" class="control-label">Mobile Number</label>
                                    <input type="text" class="form-control" v-model="customerForm.mobile" id="field-3" placeholder="9841xxxxxx">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="field-4" class="control-label">Address</label>
                                    <input type="text" class="form-control" v-model="customerForm.address" id="field-4" placeholder="Kathmandu, Nepal">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="field-5" class="control-label">Date of Birth (BS)</label>
                                    <input type="text" v-model="customerForm.date_of_birth" class="form-control datepicker" v-model="customerForm.dob" id=""  placeholder="">
                                </div>
                            </div>
                        </div>
        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="field-6" class="control-label">Email Address</label>
                                    <input type="text" class="form-control"  v-model="customerForm.email" id="field-6" placeholder="admin@gmail.com">
                                </div>
                            </div>
                            
        
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="field-6" class="control-label">Patient Type</label>
                                    <select class="form-control" v-model="customerForm.patient_type_id">
                                        <option value="">Normal</option>
                                        {% for patient_type in patient_types %}
                                            <option value="{{patient_type.id}}">{{patient_type.title}}</option>
                                        {% endfor %}
                                        
                                    </select>
                                </div>
                            </div>

                          
                        </div>
                        <!-- <div class="row">
                            <div class="col-md-12">
                                <div class="form-group no-margin">
                                    <label for="field-7" class="control-label">Personal Info</label>
                                    <textarea class="form-control autogrow" id="field-7" placeholder="Write something about yourself" style="overflow: hidden; word-wrap: break-word; resize: horizontal; height: 104px;"></textarea>
                                </div>
                            </div>
                        </div> -->
                    </div>
                    <div class="modal-footer">
                        <!-- <button type="button" class="btn btn-secondary waves-effect" data-dismiss="modal">Close</button> -->
                        <button type="button" class="btn btn-purple waves-effect waves-light" @click="savePatient">Add Patient</button>
                        <!-- <button  @click="savePatient">save</button> -->
              
                    </div>
                    <div v-if="message.error_status==true"class="alert alert-icon alert-danger alert-dismissible fade show mb-0" role="alert">
                        <!-- <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">×</span>
                        </button> -->
                        <i class="mdi mdi-block-helper mr-2"></i>
                        <strong>[[message.error_message_body.Fail]]</strong>
                        <strong>[[message.error_message_body.username]]</strong>
                        <strong>[[message.error_message_body.mobile]]</strong>
                        <strong>[[message.error_message_body.firstname]]</strong>
                        <strong>[[message.error_message_body.lastname]]</strong>
                        <strong>[[message.error_message_body.email]]</strong>

                    </div>
            
        </div>
</div>


{% endblock %}

{% block script %}
<script>
    // $(document).ready(function(){
    //     $('.datepicker').datepicker({
    //         format: 'yyyy-mm-dd',
    //     });
    // });
   // var Toasted = require('vue-toasted').default
   Vue.use(VueToast);
   var app = new Vue({
       
       delimiters: ['[[', ']]'],
     el: '#add_visit',
     data: {
        fk_customer_user_id : null,
        fk_doctor_user_id : null,
        appointmentDate : '',
        remarks: '',
        visit_type: '',
       selectedPatient : null,
       selectedDoctor : null,
       loading: false,
       products : [],
       doctors: [],
       showModal : false,
       patients:[],
       patient : [{
            id: 0,
            firstname: "",
            lastname: "",
            mobile: "",
            patient_type: {
                p_type_id: null,
                p_type_title: ""
            }
        }],
        message : {
            error_message_body: '',
            error_status : false,
        },
       Visit : [{
           id: 0,
           amount: "",
           fk_type_id: "", //visit-type id ho yo
           comment: "",
           cartitem_id :  "",
        //    appointmentDate : '',

   }],
   customerForm : {
        firstname : "",
        lastname: "",
        email : "",
        patient_type_id : "",
        mobile : "",
        visit_type: '',
        address: '',
        date_of_birth: ''
    },

  

}, //Data Closed
     methods : {
       saveVisit: function() {
               axios({
               method: 'post',
               url:  '/api/VisitAPIView/',
               headers: {
                               'Content-Type': 'application/json',
                               'X-CSRFToken': '{{ csrf_token }}'
                           }, 
               data: {
                    fk_customer_user_id: this.fk_customer_user_id,
                    fk_doctor_user_id : this.fk_doctor_user_id,
                    appointmentDate : '2020-01-01', //this.appointmentDate,
                    remarks : this.remarks,
                    visit_type : this.visit_type,
               },
               }) //.then(response=> cartitem.variation = response.data)
               .then((getResponse) => {
                   $('#con-close-modal').modal('hide')
                //    console.log(getResponse.data);
                    window.location='/api/VisitAPIView/?customer_id='+ getResponse.data.fk_customer_user_id;
                //    this.patientType = getResponse.data.user_id;
                   

               }) 
               .catch(function (error) {
                   console.log(error);
                   console.log("Error while fetching market updates");
               });
                 
       },
       onChangeVisitType(event){
           this.Visit.fk_type_id = event.target.value;
           console.log(event.target.value);
       },
       onChangeVariation(event){
        console.log(event.target.value);
        this.Visit.cartitem_id = event.target.value;
       },
       getPatient() {
            this.loading = true;
            axios.get('/api/patients/')
                .then((getResponse) => {
                    console.log("GET Response - patients")
                    console.log(getResponse.data);
                    // data = getResponse.data;
                    // response.send(data);
                    this.patients = getResponse.data;
                    // this.selectedPatient = '11';
                    this.loading = false;
                    // print(products);
                })
                .catch(function (error) {
                    this.loading = false;
                    console.log(error);
                    console.log("Error while fetching market updates");
                });  
        },

        getDoctors() {
            this.loading = true;
            axios.get('/api/DoctorUserListAPIView/')
                .then((getResponse) => {
                    console.log("GET Response - patients")
                    console.log(getResponse.data);
                    // data = getResponse.data;
                    // response.send(data);
                    this.doctors = getResponse.data;
                    // this.selectedPatient = '11';
                    this.loading = false;
                    // print(products);
                })
                .catch(function (error) {
                    this.loading = false;
                    console.log(error);
                    console.log("Error while fetching market updates");
                });  
        },
        savePatient: function() {
                axios({
                method: 'post',
                url:  '/api/register/',
                headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': '{{ csrf_token }}'
                            }, 
                data: {
                    firstname : this.customerForm.firstname,
                    lastname : this.customerForm.lastname,
                    mobile : this.customerForm.mobile,
                    email : this.customerForm.email,
                    date_of_birth : this.customerForm.date_of_birth,
                    address : this.customerForm.address,
                    patient_type_id : this.customerForm.patient_type_id,

                  // This is the body part
                },
                }) //.then(response=> cartitem.variation = response.data)
                .then((getResponse) => {
                    $('#con-close-modal').modal('hide')
                    console.log(getResponse.data);
                    this.getPatient();
                    // this.selectedPatient = getResponse.data.user_id;
                    this.fk_customer_user_id = getResponse.data.user_id;
                    console.log(this);
                    

                })
                .catch((error) => {    
                    console.log(error.response.data);
                    if(error.response){
                        this.message.error_message_body = error.response.data;
                        this.message.error_status = true;
                    }
                            // console.log(error.response.status);
                            // console.log(error.response.headers);
                });
                  
        }
    
     }, //end method
     

    

     mounted() {
        this.getPatient();
        this.getDoctors();
        $('.datepicker').datepicker({
            onSelect: function(dateText) { 
                $(this)[0].dispatchEvent(new Event('input', { 'bubbles': true }))
            }
            });
     },
   })
 </script>
 {% endblock %}